generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("VIEWER") // ADMIN, VIEWER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Dealer {
  id          String   @id @default(uuid())
  licenseNo   String   @unique
  deviceId    String?  @unique  // Arduino cihaz ID: "1-aktup", "2-baykal"
  title       String
  city        String?
  district    String?
  address     String?
  status      String?  // Yürürlükte, Sona Erdi
  startDate   DateTime?
  endDate     DateTime?
  distributor String?
  
  // New Fields
  taxNo       String?
  decisionNo  String?
  documentNo  String?
  contractStartDate DateTime?
  contractEndDate   DateTime?
  
  // Location
  latitude    Float?
  longitude   Float?
  
  // Telemetry
  tankLevel   Int      @default(0)
  lastData    DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Arduino Cihaz Yönetimi
model Device {
  id          String   @id @default(uuid())
  deviceId    String   @unique  // Arduino'daki device_id: "1-aktup"
  name        String             // Görünen ad: "Aktup Arduino #1"
  description String?            // Açıklama
  status      String   @default("active")  // active, inactive, maintenance
  lastSeen    DateTime?          // Son veri gönderimi
  auth        DeviceAuth?

  // Diagnostics (firmware'dan gelen son veriler)
  rssi          Int?       // Sinyal gücü (dBm, -113 ile -51 arası)
  errStreak     Int?       // Son başarıdan beri hata sayısı
  uptimeMin     Int?       // Cihaz uptime (dakika)
  freeRam       Int?       // Kalan RAM (byte)
  lastErrReason String?    // Son hata nedeni: ok, gprs, time, http, sig

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DeviceAuth {
  id         String   @id @default(uuid())
  deviceId   String   @unique
  authMode   String   @default("signed") // signed, legacy
  secret     String?
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  device     Device   @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)

  @@index([authMode, active])
}

// Telemetri Geçmişi (Zaman Serisi)
model TelemetryHistory {
  id        String   @id @default(uuid())
  deviceId  String   // Arduino device_id
  dealerId  String?  // İlgili bayi ID (opsiyonel)
  tankLevel Int      // Tank seviyesi (0-100)
  timestamp DateTime @default(now())
  
  @@index([deviceId, timestamp])
  @@index([dealerId, timestamp])
}
